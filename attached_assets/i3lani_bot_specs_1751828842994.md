# I3lani Telegram Bot - Technical Specifications

## Table of Contents
1. [Bot Overview](#bot-overview)
2. [Core Functionality](#core-functionality)
3. [Architecture & Workflow](#architecture--workflow)
4. [Psychological Strategies](#psychological-strategies)
5. [User Interface Specifications](#user-interface-specifications)
6. [Backend API Specifications](#backend-api-specifications)
7. [Admin Panel Specifications](#admin-panel-specifications)
8. [Database Schema](#database-schema)
9. [Processing Pipeline](#processing-pipeline)
10. [Implementation Requirements](#implementation-requirements)

---

## Bot Overview

**Platform**: Telegram Bot
**Framework**: Python + aiogram
**Payment Methods**: Telegram Stars + TON Cryptocurrency
**Languages**: English 🇺🇸 (USD), Arabic 🇸🇦 (SAR), Russian 🇷🇺 (RUB)
**Purpose**: Multi-language advertising platform for Telegram channels

---

## Core Functionality

### What this bot can do:

**Primary Features:**
- Multi-language advertising platform (English/Arabic/Russian with dynamic language management)
- Multi-currency support (USD/SAR/RUB)
- Telegram channel advertisement placement system
- Payment processing via Telegram Stars and TON cryptocurrency
- Automated ad scheduling and publishing
- Referral system with affiliate tracking
- Subscription management with renewal notifications
- Real-time payment verification via TON blockchain
- Admin dashboard for content and pricing management

**Technical Capabilities:**
- aiogram framework integration for Telegram Bot API
- Blockchain transaction verification
- Multi-currency pricing calculations
- Automated scheduling system
- Database-driven content management
- Affiliate link generation and tracking

---

## Architecture & Workflow

### How should this bot work:

**Main Flow Architecture:**
```
User Entry → Language Selection → Ad Creation → Channel Selection → 
Duration Selection → Payment Processing → Verification → Publishing → 
Monitoring → Renewal Notifications
```

**State Management:**
- Use aiogram FSM (Finite State Machine) for conversation flows
- Session storage for user progress tracking
- Persistent storage for user preferences and ad data
- Queue system for scheduled ad publishing

**User Journey Flowchart:**
```
🎉 Welcome Screen → 🌍 Language Selection → 📢 Step 1: Create Ad → 
🎯 Step 2: Choose Channel → ⏰ Step 3: Choose Duration → 
💰 Payment Summary → 💳 Payment Instructions → 
✅ Payment Confirmed → 📝 Publishing Agreement → 
📢 Ad Goes Live → 📊 My Ads Dashboard
```

---

## Psychological Strategies

### What strategies does the bot follow:

**Pricing Psychology:**
- **Decoy Effect**: Business Tips channel as decoy to make Tech News more attractive
- **Anchor Pricing**: Show full price then discount
- **Default Bias**: Pre-select 6-month "Best Value" option
- **FOMO Tactics**: Limited-time offers, countdown timers
- **Sunk Cost Fallacy**: Multi-step process increases commitment
- **Exit Intent**: Counter-offers when users try to cancel

**Retention Strategies:**
- **Loop Trap**: Dashboard keeps users engaged
- **Renewal Urgency**: 48-hour and 2-hour expiration warnings
- **Referral Incentives**: Free posting days for successful referrals
- **Discount Laddering**: 5% friend discount, 3-day bonus offers

**Behavioral Strategy Mapping:**
| Step | Applied UX Psychology |
|------|----------------------|
| Welcome | Foot-in-the-door, Hidden Pricing |
| Step 1 (Create Ad) | Endowment Effect |
| Step 2 (Choose Channel) | Default Bias, FOMO |
| Step 3 (Choose Duration) | Sunk Cost Fallacy, Decoy Pricing |
| Payment | Gate Critical Action |
| Cancel Attempt | Smart Offer, Confirmshaming |
| Publishing Agreement | Commitment Bias, Loss Aversion |
| My Ads Dashboard | Loop Trap, Friction on Cancel |

---

## User Interface Specifications

### User Menu Structure:

**Main Menu (Menu Button):**
```
🎯 Create New Ad
📊 My Ads Dashboard
💰 Pricing & Packages
🔗 Share & Earn
⚙️ Settings
🆘 Help & Support
```

**Inline Keyboard Layouts:**

**Language Selection:**
```
🇺🇸 English - USD
🇸🇦 Arabic - SAR
🇷🇺 Russian - RUB
```

**Channel Selection:**
```
📈 Tech News (45K) 🔥 Most Popular
🎮 Gaming Hub (32K)
💼 Business Tips (28K) 🪤 Decoy
```

**Duration Options:**
```
⏰ 1 Month - Base Price
⏰ 3 Months - Save 5 TON 💰
⏰ 6 Months - Save 20 TON 🔥 Best Value
```

**Payment Methods:**
```
⭐ Pay with Telegram Stars
🪙 Pay with TON
```

**Share & Earn Menu:**
```
[Share Now] 🎁
📊 My Referrals
💰 Earned Rewards
```

### Key UI Requirements:

1. **One-Click Copy**: Wallet address and memo must be copyable with single tap
2. **Memo Format**: AB0102 (not INV_××××)
3. **Bot Profile**: Multi-language bot description before /start
4. **Menu Button**: Always visible menu button in chat interface
5. **Back Navigation**: Users can always go back to edit
6. **Progress Indicators**: Show current step in multi-step flows

---

## Backend API Specifications

### User Menu Backend:

**User Management API:**
```python
# User Registration & Profile
POST /api/user/register
GET /api/user/profile
PUT /api/user/language
PUT /api/user/currency

# User Session Management
POST /api/user/session/create
GET /api/user/session/current
DELETE /api/user/session/end
```

**Ad Management API:**
```python
# Ad Operations
POST /api/ad/create
GET /api/ad/list
GET /api/ad/{ad_id}
PUT /api/ad/{ad_id}/status
POST /api/ad/{ad_id}/renew
DELETE /api/ad/{ad_id}

# Ad Publishing
POST /api/ad/{ad_id}/publish
GET /api/ad/{ad_id}/statistics
```

**Payment Processing API:**
```python
# Payment Operations
POST /api/payment/create
POST /api/payment/verify
GET /api/payment/history
GET /api/payment/{payment_id}/status

# TON Blockchain Integration
POST /api/payment/ton/verify
GET /api/payment/ton/transaction/{tx_hash}
```

**Referral System API:**
```python
# Referral Management
POST /api/referral/generate
GET /api/referral/track
POST /api/referral/reward
GET /api/referral/statistics
```

### Backend Services:

**Core Services:**
- **UserService**: Profile management, preferences, authentication
- **AdService**: Ad creation, validation, scheduling, publishing
- **PaymentService**: Transaction processing, verification, refunds
- **ChannelService**: Channel management, posting, analytics
- **ReferralService**: Affiliate tracking, reward distribution
- **NotificationService**: Renewal reminders, confirmations
- **LanguageService**: Multi-language content management

---

## Admin Panel Specifications

### Admin Menu Structure:

**Admin Dashboard:**
```
📊 Analytics & Reports
👥 User Management
📢 Channel Management
💰 Pricing Control
🌍 Language Management
📝 Content Management
🎯 Promotional Offers
🔧 System Settings
```

### Admin Functions:

**Channel Management:**
- Add/remove channels
- Adjust channel pricing
- Monitor channel performance
- Set channel popularity flags

**Language Control:**
- Add/remove supported languages
- Edit translations
- Manage currency mappings
- Update bot descriptions

**Pricing Dashboard:**
- Dynamic price adjustments
- Discount campaign management
- Duration package configuration
- Promotional offer setup

**User Analytics:**
- Registration trends
- Payment statistics
- User engagement metrics
- Referral performance

### Admin Menu Backend:

**Analytics API:**
```python
# Analytics & Reporting
GET /admin/analytics/users
GET /admin/analytics/revenue
GET /admin/analytics/channels
GET /admin/analytics/referrals
GET /admin/analytics/payments
```

**Channel Management API:**
```python
# Channel Operations
GET /admin/channels/list
POST /admin/channels/create
PUT /admin/channels/{channel_id}
DELETE /admin/channels/{channel_id}
GET /admin/channels/{channel_id}/stats
```

**Pricing Management API:**
```python
# Pricing Control
GET /admin/pricing/channels
PUT /admin/pricing/channels/{channel_id}
GET /admin/pricing/durations
PUT /admin/pricing/durations
POST /admin/pricing/promotions
```

**Content Management API:**
```python
# Content & Language Management
GET /admin/content/languages
PUT /admin/content/languages/{lang_code}
GET /admin/content/descriptions
PUT /admin/content/descriptions
GET /admin/content/terms
PUT /admin/content/terms
```

**User Management API:**
```python
# User Administration
GET /admin/users/list
GET /admin/users/search
POST /admin/users/{user_id}/ban
POST /admin/users/{user_id}/unban
GET /admin/users/{user_id}/activity
```

---

## Database Schema

### Required Tables:

**Users Table:**
```sql
CREATE TABLE users (
    user_id BIGINT PRIMARY KEY,
    username VARCHAR(255),
    language VARCHAR(10) DEFAULT 'en',
    currency VARCHAR(10) DEFAULT 'USD',
    referrer_id BIGINT,
    total_spent DECIMAL(10,2) DEFAULT 0,
    free_posts_remaining INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status ENUM('active', 'banned', 'suspended') DEFAULT 'active'
);
```

**Ads Table:**
```sql
CREATE TABLE ads (
    ad_id INT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    content TEXT NOT NULL,
    media_url VARCHAR(500),
    link_url VARCHAR(500),
    status ENUM('draft', 'active', 'paused', 'expired') DEFAULT 'draft',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(user_id)
);
```

**Subscriptions Table:**
```sql
CREATE TABLE subscriptions (
    subscription_id INT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    ad_id INT NOT NULL,
    channel_id INT NOT NULL,
    duration_months INT NOT NULL,
    start_date TIMESTAMP NOT NULL,
    end_date TIMESTAMP NOT NULL,
    total_price DECIMAL(10,2) NOT NULL,
    currency VARCHAR(10) NOT NULL,
    status ENUM('active', 'expired', 'cancelled') DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(user_id),
    FOREIGN KEY (ad_id) REFERENCES ads(ad_id),
    FOREIGN KEY (channel_id) REFERENCES channels(channel_id)
);
```

**Payments Table:**
```sql
CREATE TABLE payments (
    payment_id INT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    subscription_id INT,
    amount DECIMAL(10,2) NOT NULL,
    currency VARCHAR(10) NOT NULL,
    payment_method ENUM('telegram_stars', 'ton') NOT NULL,
    memo VARCHAR(20) NOT NULL,
    tx_hash VARCHAR(255),
    status ENUM('pending', 'completed', 'failed', 'refunded') DEFAULT 'pending',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    verified_at TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(user_id),
    FOREIGN KEY (subscription_id) REFERENCES subscriptions(subscription_id)
);
```

**Channels Table:**
```sql
CREATE TABLE channels (
    channel_id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(255) NOT NULL,
    telegram_channel_id VARCHAR(255) NOT NULL,
    subscribers INT DEFAULT 0,
    base_price_usd DECIMAL(10,2) NOT NULL,
    is_popular BOOLEAN DEFAULT FALSE,
    is_decoy BOOLEAN DEFAULT FALSE,
    active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**Referrals Table:**
```sql
CREATE TABLE referrals (
    referral_id INT PRIMARY KEY AUTO_INCREMENT,
    referrer_id BIGINT NOT NULL,
    referee_id BIGINT NOT NULL,
    channel_id INT NOT NULL,
    reward_granted BOOLEAN DEFAULT FALSE,
    discount_used BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (referrer_id) REFERENCES users(user_id),
    FOREIGN KEY (referee_id) REFERENCES users(user_id),
    FOREIGN KEY (channel_id) REFERENCES channels(channel_id)
);
```

---

## Processing Pipeline

### Bot Processing Architecture:

**1. Message Processing:**
```python
@dp.message_handler(commands=['start'])
async def start_handler(message: Message, state: FSMContext):
    # Check if user exists
    # Display bot profile/description
    # Initialize language selection
    # Set initial state
```

**2. State Machine Implementation:**
```python
class AdCreationStates(StatesGroup):
    language_selection = State()
    ad_content = State()
    media_upload = State()
    channel_selection = State()
    duration_selection = State()
    payment_method = State()
    payment_confirmation = State()
    publishing_agreement = State()
    ad_live = State()
```

**3. Payment Processing Pipeline:**
```python
async def process_payment_workflow():
    # Generate unique memo (AB0102 format)
    # Create payment invoice
    # Display payment instructions with copy buttons
    # Start payment monitoring
    # Verify transaction via tonviewer.com API
    # Update subscription status
    # Send confirmation to user
    # Schedule ad publishing
```

**4. Ad Publishing System:**
```python
async def ad_publishing_pipeline():
    # Verify payment completion
    # Check publishing agreement acceptance
    # Queue ad for publishing
    # Post to selected channels
    # Send confirmation to user
    # Update analytics
    # Schedule renewal reminders
```

**5. Notification System:**
```python
async def notification_scheduler():
    # Monitor subscription expiration dates
    # Send 48-hour warning
    # Send 2-hour urgent reminder with offer
    # Handle renewal responses
    # Process expired subscriptions
```

**6. Referral Processing:**
```python
async def referral_system():
    # Generate unique referral links
    # Track referral conversions
    # Calculate rewards (free posting days)
    # Apply friend discounts (5%)
    # Update user balances
    # Send reward notifications
```

---

## Implementation Requirements

### Technical Stack:

**Core Technologies:**
- Python 3.9+
- aiogram 3.x
- PostgreSQL/MySQL
- Redis (for caching and queues)
- Celery (for background tasks)

**External APIs:**
- Telegram Bot API
- TON Blockchain API
- tonviewer.com API
- Telegram Stars Payment API

### Key Implementation Details:

**1. Memo Generation:**
```python
def generate_memo():
    # Format: AB0102 (not INV_××××)
    # Use alphanumeric characters
    # Ensure uniqueness
    # 6-character length
```

**2. Payment Verification:**
```python
async def verify_ton_payment(memo: str, expected_amount: float):
    # Query tonviewer.com API
    # Match memo and amount
    # Verify transaction confirmation
    # Update payment status
```

**3. Multi-language Support:**
```python
class LanguageManager:
    def __init__(self):
        self.translations = {
            'en': {...},
            'ar': {...},
            'ru': {...}
        }
    
    def get_text(self, key: str, lang: str):
        return self.translations[lang].get(key, key)
```

**4. Pricing Engine:**
```python
class PricingEngine:
    def calculate_price(self, channel_id: int, duration: int, currency: str):
        base_price = self.get_channel_base_price(channel_id)
        duration_multiplier = self.get_duration_multiplier(duration)
        discount = self.get_duration_discount(duration)
        final_price = (base_price * duration_multiplier) - discount
        return self.convert_currency(final_price, currency)
```

### Security Requirements:

**1. Data Protection:**
- Encrypt sensitive user data
- Secure payment information
- Implement rate limiting
- Validate all user inputs

**2. Payment Security:**
- Verify all transactions
- Implement timeout mechanisms
- Log all payment attempts
- Secure memo generation

**3. Bot Security:**
- Implement flood protection
- Validate webhook signatures
- Secure admin access
- Monitor for abuse

### Performance Requirements:

**1. Response Time:**
- Bot responses < 2 seconds
- Payment verification < 30 seconds
- Ad publishing < 5 minutes

**2. Scalability:**
- Support 10,000+ concurrent users
- Handle 1,000+ payments per hour
- Process 10,000+ ads per day

**3. Reliability:**
- 99.9% uptime
- Automatic failover
- Data backup and recovery
- Error handling and logging

---

## Conclusion

This technical specification provides a comprehensive foundation for developing the I3lani Telegram bot with all required features, psychological pricing strategies, and user experience optimizations. The modular architecture ensures scalability and maintainability while the detailed API specifications enable clear development workflows for both frontend and backend teams.